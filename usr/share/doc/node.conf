#
# Template etc/node.conf
#
#   This configuration file describes node-wide parameters.
#
#   This file can be left empty except for node.host_mode. The sync
#   schedule is autogenerated, based on the schedules described in the
#   sync#* resources defined in the service configurations. So no
#   sync schedule should be explicitely defined here.
#
#   The internal schedule default for push actions is:
#     push actions          00:00-06:00@361 mon-sun
#     sync actions          04:00-06:00@121 mon-sun
#     compliance actions    02:00-06:00@241 sun
#     inventory actions     none
#
#   Schedule parameters details:
#     [!] <timeranges> [<days> [<weeks> [<months>]]]
#
#     !
#        desc: exclusion pattern. ommiting the ! implies an inclusion
#              pattern
#
#     <timeranges> := <timerange>[,<timerange>]
#       <timerange> := <begin>:<end>@<interval>
#          <begin> <end> := <hour>:<minute>
#          <interval>
#            type: integer
#            unit: minutes
#
#     <days> := <day>[-<day>][,<day>[-<day>]]
#        <day> := <day_of_week>[:<day_of_month>]
#          <day_of_week>
#             * iso week day format
#               type: integer between 0 and 6
#             * literal format
#               type: string in ("mon", "tue", "wed", "thu", "fri", "sat",
#                     "sun", "monday", "tuesday", "wednesday", "thursday",
#                     "friday", "saturday", "sunday")
#          <day_of_month> := <literal> | +<nth> | -<nth> | <nth>
#             <nth>
#               type: integer
#             <literal>
#               type: string in ("first", "1st", "second", "2nd", "third",
#                     "3rd", "fourth", "4th", "fifth", "5th", "last")
#
#     <weeks> := <week>[-<week>][,<week>[-<week>]]
#        <week>
#          type: integer between 1 and 53
#
#     <months> := <monthrange>[,<monthrange>]
#        <monthrange> := <month>[-<month>] | <month_filter>
#          <month>
#            * numeric month format
#              type: integer between 1 and 12
#            * literal format
#              type: string in ("jan", "feb", "mar", "apr", "may", "jun",
#                    "jul", "aug", "sep", "oct", "nov", "dec", "january",
#                    "february", "march", "april", "may", "june", "july",
#                    "august", "september", "october", "november",
#                    "december")
#          <month_filter> := %<modulo>[+<shift>]
#            <modulo>
#              type: integer
#            <shift>
#              type: integer
#
# Example schedule:
# * schedule = 16:00-17:00@1 sat:last,tue-mon:last * %2+1,feb-apr
#
#   reads as "once a minute between 16:00 and 17:00 on last monday,
#   tuesday and saturday of every even months plus february and
#   april".
#
# * schedule = ["06:00-07:00@61 *:1,-1", "! * * * feb"]
#
#   reads as "once between 6 and 7am every first and last day of every
#   month except february".
#

[node]
#
# A PRD env only allows PRD services to run. A not-PRD env allows any
# services to run.
#
;env = DEV

#
# Allow a maximum of <max_parallel> subprocesses to run simultaneously
# on "svcmgr --parallel <action>" commands. Defaults to 10.
#
;max_parallel = 5

#
# You can optionally define asset information. They will be pushed to the
# collector, so that the compliance ruleset can use this information just
# after opensvc is bootstraped.
#
# A postinstall workflow would look like this: 
#
#   vanilla install
#   install opensvc
#   nodemgr set --param node.loc_city = Paris
#   nodemgr set --param node.team_responsible = Homies
#   nodemgr pushasset --force
#   nodemgr compliance attach moduleset --moduleset sys.core
#   nodemgr compliance fix
#
;loc_country = France
;loc_city = Paris
;loc_zip = 75017
;loc_addr = 7 rue blanche
;loc_building = crystal
;loc_floor = 21
;loc_room = 102
;loc_rack = R42

#
# Set the uri of the collectors' xmlrpc servers
# The path path of the url can be left unspecified.
# If dbcompliance is not set, its value is deduced from dbopensvc.
#
;dbopensvc = https://collector.opensvc.com
;dbopensvc = https://collector.opensvc.com/feed/default/call/xmlrpc
;dbcompliance = https://collector.opensvc.com/init/compliance/call/xmlrpc

#
# 'branch'
#   Set the targeted opensvc agent branch. The downloaded upgrades will
#   honor that branch.
#   The default is 'not set', which means the repopkg imposes the target
#   branch, which is not recommended with a public repopkg.
#
;branch = 1.9

#
# 'repo'
#   Set the uri of the opensvc agent package repository and compliance
#   modules gzipped tarball repository. This parameter is used by
#   'nodemgr updatepkg' and 'nodemgr updatecomp' commands
#
# ROOT
# +- compliance
#  +- compliance.tar.gz
#  +- current -> compliance.tar.gz
# +- packages
#  +- deb
#  +- depot
#  +- pkg
#  +- rpms
#   +- current -> opensvc-1.4-49.rpm
#   +- opensvc-1.4-48.rpm
#   +- opensvc-1.4-49.rpm
#   +- opensvc-1.4-50.rpm
#  +- tbz
#
;repo = http://opensvc.repo.corp

#
# 'repopkg'
#   Set the uri of the opensvc agent package repository. This parameter
#   is used by'nodemgr updatepkg' command. The repository file tree must
#   be organized as:
#
# ROOT
# +- deb
# +- depot
# +- pkg
# +- rpms
#  +- current -> opensvc-1.4-49.rpm
#  +- opensvc-1.4-48.rpm
#  +- opensvc-1.4-49.rpm
#  +- opensvc-1.4-50.rpm
# +- tbz
#
;repopkg = http://repo.opensvc.com

#
# 'repocomp'
#   Set the uri of the opensvc compliance modules gzipped tarbal repository.
#   This parameter is used by'nodemgr updatecomp' command.
#
# ROOT
# +- compliance.tar.gz
# +- current -> compliance.tar.gz
#
;repocomp = http://repo.opensvc.com

#
# 'ruser'
#   Set the remote user to use to login to a remote node with ssh and
#   rsync. The remote user must have the privileges to run as root the
#   following commands on the remote node:
#    - nodemgr
#    - svcmgr
#    - rsync
#   The default ruser is root for all nodes. ruser accepts a list of
#   user[@node] ... If @node is ommited, user is considered the new
#   default user
#
;ruser = opensvc
;ruser = root opensvc@node1
;ruser = usr1@node1 usr2@node2 usr3@node3

#
# 'maintenance_grace_period'
#   A duration expression, like 1h30m, defining how long the daemon retains
#   a remote in-maintenance node data. As long as the remote node data are
#   retained, the local daemon won't opt-in to takeover its running instances.
#   This parameter should be adjusted to span the node reboot time, so the
#   services have a chance to be restarted on the same node if their
#   placement was optimal.
#   The default is 60s.
#
;maintenance_grace_period = 60

#
# 'rejoin_grace_period'
#   A duration expression, like 90m, defining how long the daemon restrains
#   from taking start decisions if no heartbeat has been received from a
#   peer since daemon startup.
#
;rejoin_grace_period = 90

#
# 'ready_period'
#   A duration expression, like 10s, defining how long the daemon monitor
#   waits before starting a service instance in ready state. A peer node
#   can preempt the start during this period. The default is 16s. Usually 
#   set to allow at least a couple of heartbeats to be received.
#
;ready_period = 10

#
# Schedule parameters for the 'compliance check' node action
#
[compliance]
;schedule = 00:00-23:59@1440 sat,sun

#
# 'auto_update'
#   Boolean. Default False.
#   If set to True, and if the execution context indicates a scheduled run,
#   execute 'updatecomp' upon 'compliance check'. 
#   This toggle helps keep the compliance modules in sync with the reference
#   repository. Beware of the security impact of this setting: you must be
#   careful your module repository is kept secure from malevolents.
#
;auto_update = False

[stats]
;schedule = @60
;disable = blockdev, mem_u

[checks]
;schedule = @120

[packages]
;schedule = @1440 sun

[patches]
;schedule = @1440 sun

[asset]
;schedule = 04:00-05:59@120

[nsr]
;schedule = 04:00-05:59@120

[dcs]
;schedule = 04:00-05:59@120

[hds]
;schedule = 04:00-05:59@120

[necism]
;schedule = 04:00-05:59@120

[eva]
;schedule = 04:00-05:59@120

[ibmsvc]
;schedule = 04:00-05:59@120

[vioserver]
;schedule = 04:00-05:59@120

[brocade]
;schedule = 04:00-05:59@120

[disks]
;schedule = 04:00-05:59@120

[sym]
;schedule = 04:00-05:59@120

[svcconf]
;schedule = 04:00-05:59@120

[appinfo]
;schedule = @120

[rotate_root_pw]
;schedule = 04:00-05:59@120 sun

#
# In pull action mode, the collector sends a tcp packet to the server
# to notify there are actions to unqueue. The system's inetd sysstem
# must be configured to execute "nodemgr dequeue actions" upon
# receive. The listener.port parameter is sent to the collector upon
# pushasset. The collector uses this port to notify the node.
#
[listener]
addr = 0.0.0.0
port = 1214

[syslog]
#
# The facility to log to. Defaults to "daemon".
#
facility = user

#
# The minimum message criticity to feed to syslog.
# Valid values: critical, error, warning, info, debug, notset
# Default: info
#
# Setting to critical actually disables the syslog logging, as the
# agent does not emit message at this level.
#
;level = critical

#
# The host and port to log to. If neither host nor port are specified
# and if /dev/log exists, the messages are posted to /dev/log.
# If host is set but port is not, port defaults to 514
# If port is set bit host is not, host defaults to 514
#
;host = localhost
;port = 514

[stats_collection]
;schedule = @10

[reboot]
#
# A command to execute before reboot. Errors are ignored.
#
;pre = logger foo

#
# A command to execute before reboot. Errors abort to reboot.
#
;blocking_pre = ls /foo
;schedule = @1441 wed

#
# If once is set to false, do not remove the reboot flag before rebooting,
# so that the node is ready to reboot again in the next allowed timerange.
# This setup is needed to enforce a periodic reboot, with a patching script
# hooked as a pre trigger for example.
#
# If not set, or set to true, the reboot flag is removed before reboot, and
# a 'nodemgr schedule reboot' is needed to rearm.
#
;once = false


[cluster]
#
# The cluster name.
# This information is fetched from the join command payload received from the
# joined node.
#
;name = cluster1

#
# The cluster shared secret. Used to encrypt/decrypt data with AES256.
# This secret is either autogenerated or fetched from a join command.
#
;secret = 12331241421412412

#
# The cluster nodes list.
# This list is fetched from the join command payload received from the
# joined node.
#
;nodes = node1 node2 node3

#
# Should a split segment of the cluster commit suicide. Default is False.
# If set to true, please set at least 2 arbitrators so you can rolling
# upgrade the opensvc daemons.
#
;quorum = false


#
# An arbitrator is a opensvc node (running the usual osvc daemon) this
# cluster nodes can ask for a vote when the cluster is split.
#
# Arbitrators are tried in sequence, the first reachable arbitrator
# gives a vote. In case of a real split, all arbitrators are expected to
# be unreachable from the lost segment. At least one of them is
# expected to be reachable from the surviving segment.
#
# Arbitrators of a cluster must thus be located close enough to each
# other, so a subset of arbitrators can't be reachable from a split
# cluster segment, while another subset of arbitrators is reachable
# from the other split cluster segment. But not close enough so they can
# all fail together. Usually, this can be interpreted as: same site,
# not same rack and power lines.
#
# Arbitrators usually don't run services, even though they could, as their
# secret might be known by multiple clusters of different responsibles.
#
# Arbitrators can be tested using "nodemgr ping --node <arbitrator name>"
#
[arbitrator#0]
name = node3
secret = 12331241421413413

[hb#0]
;type = unicast
#
# The ip address of each node. Defaults to 0.0.0.0 for listening and to
# the resolved nodename for sending.
#
;addr@node1 = 1.2.3.4
;addr@node2 = 1.2.3.5

#
# The interface to bind. Defaults the any interface chosen by the system for
# the address.
#
;intf@node1 = eth0
;intf = eth1

#
# The port for each node to send to or listen on. Defaults to 1214.
#
;port@node1 = 1215
;port = 1214

#
# The delay since the last received heartbeat from a node before considering
# this node is gone. 
#
;timeout = 15

[hb#1]
;type = multicast

#
# The multicast address to send to and listen on.
#
;addr = 224.3.29.71

#
# The interface to bind. Defaults the any interface chosen by the system for
# the address.
#
;intf@node1 = eth0
;intf = eth1

#
# The multicast port to send to and listen on.
#
;port = 10001

#
# The delay since the last received heartbeat from a node before considering
# this node is gone. 
#
;timeout = 15


[hb#2]
;type = disk

#
# The device to write the hearbeats to and read from. It must be dedicated to
# the daemon use. Its size should be 1M + 1M per cluster node.
#
;dev = /dev/mapper/31231321231231241241343141243

#
# The delay since the last written heartbeat from a node before considering
# this node is gone. 
#
;timeout = 15

[stonith#node1]
cmd = /bin/true
